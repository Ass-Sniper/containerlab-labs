name: egp-igp-rr

topology:
  defaults:
    kind: linux
    image: quay.io/frrouting/frr:10.5.0

    binds:
      - ../configs/common/daemons:/etc/frr/daemons
      - ../configs:/configs

    exec:
      # 基础
      - sh -c "ip link set lo up"

      # 注入 FRR 配置（声明式）
      - sh -c "cat /configs/common/frr-common.conf /configs/$(hostname)/frr.conf > /etc/frr/frr.conf"
      - sh -c "cp /configs/common/vtysh.conf /etc/frr/vtysh.conf"

      # 权限（FRR 镜像强制要求）
      - sh -c "chown frr:frr /etc/frr/frr.conf"
      - sh -c "chmod 640 /etc/frr/frr.conf"
      - sh -c "chown frr:frrvty /etc/frr/vtysh.conf"
      - sh -c "chmod 660 /etc/frr/vtysh.conf"

      # 显式 reload FRR 配置：
      # containerlab exec 写入 /etc/frr/frr.conf 发生在 FRR 守护进程启动之后，
      # bgpd/ospfd 只在启动时读取一次配置文件，不会自动感知文件变更。
      # vtysh -b 会将磁盘上的配置加载到运行态，避免出现
      # “配置存在但 BGP instance not found”的问题。
      - sh -c "vtysh -b"

      # ⚠️ 注意：不再手动 vtysh
      # FRR 会在 docker-start → watchfrr 阶段自动加载配置

  nodes:
    r1: {}
    r2: {}
    r3: {}
    r4: {}
    r5: {}
    r6: {}

  links:
    - endpoints: ["r1:eth1", "r3:eth1"]
    - endpoints: ["r2:eth1", "r3:eth2"]
    - endpoints: ["r3:eth3", "r4:eth3"]
    - endpoints: ["r4:eth1", "r5:eth1"]
    - endpoints: ["r4:eth2", "r6:eth1"]
