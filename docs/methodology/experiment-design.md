
# containerlab-labs 实验设计方法论（experiment-design）

## 1. 文档目的

本文档定义在 **containerlab-labs** 中设计一次“高质量网络实验”的方法论。

目标不是：

> “把协议跑起来”

而是：

> **验证一个明确假设，并得到可解释、可复现、可对比的结论**

该方法论适用于：

* FRR / SONiC 控制面实验
* BGP / OSPF / EVPN / VXLAN
* 架构类实验（RR / 多 AS / 分层控制面）
* 行为对比实验（版本 / NOS / 参数）

---

## 2. 什么是一个「好实验」

一个合格的实验，必须同时满足以下四点：

| 维度 | 要求                |
| -- | ----------------- |
| 目标 | 明确回答一个问题          |
| 变量 | 清楚区分“控制变量 / 实验变量” |
| 证据 | 有抓包或状态证据          |
| 结论 | 可被复现实验验证          |

如果任何一项缺失，这个实验都 **不应被归档**。

---

## 3. 实验设计的核心：假设驱动（Hypothesis-driven）

### 3.1 禁止“无假设实验”

❌ 错误示例：

> “看看 BGP RR 怎么工作”

✅ 正确示例：

> “在 AS 内使用 RR 后，iBGP 邻居数量从 N² 降为 N，且路由可达性不变”

---

### 3.2 标准实验假设格式（推荐）

```text
如果【做了某件事 / 修改了某个参数】，
那么【网络行为会发生某种变化】，
因为【协议机制 / RFC 约束】。
```

#### 示例（RR）

```text
如果在 AS65001 内引入 Route Reflector，
那么客户端无需 iBGP full-mesh 仍可学习到对端 AS 路由，
因为 RR 会在 iBGP 会话中反射 UPDATE。
```

---

## 4. 变量设计（最容易出错的部分）

### 4.1 三类变量定义

| 类型   | 定义       | 示例              |
| ---- | -------- | --------------- |
| 固定变量 | 所有实验不变   | 拓扑、IP、镜像版本      |
| 实验变量 | 本次实验唯一变化 | LocalPref / MED |
| 观测变量 | 被测结果     | best-path 变化    |

---

### 4.2 一次实验 = 一个实验变量

❌ 错误：

* 同时改 LocalPref + AS_PATH + MED

✅ 正确：

* 本次实验只改 LocalPref
* 其他保持完全一致

> **一个实验只能验证一个因果关系**

---

## 5. 拓扑设计原则

### 5.1 拓扑必须“最小但充分”

* 节点数：最小化
* 路径数：必须大于 1
* 否则无“选择”可言

#### 示例

| 实验           | 最少节点       |
| ------------ | ---------- |
| iBGP RR      | 3          |
| RR + eBGP    | 5          |
| LocalPref 对比 | ≥2 eBGP 路径 |

---

### 5.2 禁止“顺手加节点”

❌ “反正多加两个也不影响”

这是 **实验污染的开始**。

---

## 6. 配置设计原则

### 6.1 配置必须“可读”

* 每个配置文件只体现一个角色
* 禁止复制粘贴后不清理

推荐结构：

```text
configs/
├── rr/
├── client/
└── asbr/
```

---

### 6.2 配置即文档

好的配置文件应当：

* 不看 README 也能理解其角色
* 不需要猜测“为什么要配这行”

---

## 7. 观测与证据设计

### 7.1 CLI 不是证据，抓包才是

| 手段      | 角色 |
| ------- | -- |
| show 命令 | 状态 |
| tcpdump | 行为 |
| pcap    | 证据 |

> **实验结论必须能在 pcap 中找到依据**

---

### 7.2 抓包要有目的

❌ 错误：

> “先抓下来再说”

✅ 正确：

> “我要验证 RR 是否反射 UPDATE”

---

## 8. 对照实验（Comparison）

### 8.1 为什么要做对照实验

没有对照，就没有因果。

#### 示例

| 实验组        | 条件    |
| ---------- | ----- |
| Control    | 无 RR  |
| Experiment | 启用 RR |

---

### 8.2 对照必须只差一个变量

如果你：

* 改 RR
* 又改 next-hop-self

那你**永远不知道是谁起作用**。

---

## 9. 分析文档写作规范

### 9.1 禁止“流水账”

❌ 错误：

> “然后我执行了 show ip bgp，看到了这些路由”

✅ 正确：

> “R3 学到前缀 X，但未反射给 R1，原因是…”

---

### 9.2 推荐分析结构

```text
现象 → 证据 → 机制 → 结论
```

---

## 10. 常见反模式（Anti-patterns）

* ❌ 一个实验改 5 个参数
* ❌ 无抓包直接下结论
* ❌ 拓扑复杂但问题简单
* ❌ 实验结论依赖“感觉”
* ❌ 用 latest 镜像对比行为

---

## 11. 与实验生命周期的关系

experiment-design.md 解决的是：

> **实验前：如何设计**

experiment-lifecycle.md 解决的是：

> **实验过程：如何执行**

两者必须配合使用。

---

## 12. 总结

> **好的实验不是“复杂”，而是“克制”。**

克制体现在：

* 拓扑克制
* 变量克制
* 结论克制

containerlab-labs 的实验设计方法论，确保：

* 每个实验都有明确价值
* 每个结论都有证据支撑
* 每次实验都能被复现和挑战

---
